<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minimum Viable Refugee</title>
<meta name="description" content="Minimum Viable Refugee — Enter your monthly take-home income and see how livable different cities are for a single person or two people, with 1BR/2BR rent and a clear monthly total." />
<style>
  :root{
    --bg:#0b0e13; --surface:#0f1420; --text:#eaf1ff; --muted:#a9b3c7;
    --brand:#6aa8ff; --brand2:#8cffd1; --line:#1a2336; --card:#11182a;
    --chip:#182033; --shadow:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,14,19,.98),rgba(11,14,19,.7) 60%,rgba(11,14,19,0));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .h-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .badge{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#061018}
  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;padding:0 16px 14px}
  .f{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:10px}
  .f label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .f input,.f select{width:100%;padding:10px;border-radius:8px;border:1px solid #22324d;background:#0c121f;color:var(--text)}
  .seg{display:flex;gap:8px}
  .seg button{flex:1;padding:10px;border-radius:8px;border:1px solid #22324d;background:#0c121f;color:#d7e6ff;cursor:pointer}
  .seg button[aria-pressed="true"]{background:#1a2742}
  .mini{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:12px 0 70px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);cursor:pointer}
  .img{aspect-ratio:16/9;background:#0e1526;position:relative}
  .img img{width:100%;height:100%;object-fit:cover;display:block}
  .chip{position:absolute;left:10px;top:10px;background:rgba(10,16,28,.8);border:1px solid #1f2b46;border-radius:999px;padding:6px 10px;font-size:12px}
  .body{padding:14px}
  .title{display:flex;align-items:center;justify-content:space-between}
  .title h3{margin:0;font-size:18px}
  .rows{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .row{background:#0c121f;border:1px solid #1b2742;border-radius:10px;padding:10px}
  .k{font-size:12px;color:var(--muted)}
  .v{margin-top:4px;font-weight:700}
  .details{display:none;border-top:1px solid #1b2742;margin-top:12px;padding-top:12px}
  .card.open .details{display:block}
  .pill{display:inline-block;background:var(--chip);border:1px solid #223055;border-radius:999px;padding:6px 10px;font-size:12px;margin-right:6px;margin-bottom:6px}
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #2a3654;border-radius:12px;background:#0c121f}
  footer{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(11,14,19,.98),rgba(11,14,19,.6));border-top:1px solid var(--line)}
  .foot{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .sum{font-size:13px;color:var(--muted)}
  @media (max-width:1024px){ .grid{grid-template-columns:repeat(2,1fr)} .f{grid-column:span 6} }
  @media (max-width:680px){ .grid{grid-template-columns:1fr} .f{grid-column:span 12} .rows{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="h-row wrap">
    <div class="brand"><div class="badge">⛑️</div><div>Minimum Viable Refugee</div></div>
  </div>

  <div class="controls wrap" role="region" aria-label="Controls">
    <div class="f" style="grid-column:span 4">
      <label for="income">Monthly take-home income (USD)</label>
      <input id="income" type="number" min="0" step="50" value="6000" />
      <div class="mini">We compute what share of that income each city would consume.</div>
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Household</label>
      <div class="seg" role="group" aria-label="Household">
        <button id="btnSingle" aria-pressed="true">Single</button>
        <button id="btnTwo" aria-pressed="false">Two</button>
      </div>
      <div class="mini">Affects the non-rent parts of the total.</div>
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Bedrooms</label>
      <div class="seg" role="group" aria-label="Bedrooms">
        <button id="btn1BR" aria-pressed="true">1BR</button>
        <button id="btn2BR" aria-pressed="false">2BR</button>
      </div>
      <div class="mini">Affects rent only; total adjusts accordingly.</div>
    </div>

    <div class="f" style="grid-column:span 8">
      <label for="search">Search</label>
      <input id="search" type="search" placeholder="Search cities or countries…" />
    </div>

    <div class="f" style="grid-column:span 4">
      <label for="sort">Sort</label>
      <select id="sort">
        <option value="pctAsc">% of income ↑</option>
        <option value="pctDesc">% of income ↓</option>
        <option value="costAsc">Monthly cost ↑</option>
        <option value="costDesc">Monthly cost ↓</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap" id="app" aria-live="polite"></main>

<footer>
  <div class="foot">
    <div class="sum" id="summary">Showing results</div>
    <div class="mini">Tip: press <strong>/</strong> to focus search</div>
  </div>
</footer>

<script>
// ---------- Load cities.json from the same repo (GitHub Pages) ----------
let CITIES = [];
fetch('cities.json')
  .then(r => r.json())
  .then(data => { CITIES = data; render(); })
  .catch(err => {
    console.error('Failed to load cities.json', err);
    document.querySelector('#app').innerHTML =
      '<div class="empty">Could not load cities.json. Make sure it exists in the repo root.</div>';
    document.querySelector('#summary').textContent = "Showing 0 cities";
  });

// ---------- State & helpers ----------
const $ = s => document.querySelector(s);
const money = x => `$${Math.round(x).toLocaleString()}`;

let household = "single"; // affects base total only
let bedrooms  = "1";      // affects rent only

/* Rent strictly follows bedroom selection */
function currentRent(c){
  return bedrooms === "1" ? c.rent1BR : c.rent2BR;
}

/* Adjusted total = BaseTotal − BaselineRent + SelectedRent
   Baselines:
   - costOne assumed with 1BR rent
   - costTwo assumed with 2BR rent
*/
function currentCost(c){
  const baseTotal = (household === "single") ? c.costOne : c.costTwo;
  const baselineRent = (household === "single") ? c.rent1BR : c.rent2BR;
  const selectedRent = currentRent(c);
  return baseTotal - baselineRent + selectedRent;
}

/* Compute rows with % of income + surplus/deficit */
function computeRows(){
  const income = +$("#income").value || 0;
  const q = ($("#search").value || "").trim().toLowerCase();

  let rows = CITIES.map(c=>{
    const cost = currentCost(c);
    const rent = currentRent(c);
    const pct = income>0 ? (cost / income) * 100 : null;
    const surplus = income>0 ? (income - cost) : null;
    return {...c, _cost:cost, _rent:rent, _pct:pct, _surplus:surplus};
  });

  if(q){
    rows = rows.filter(c => (`${c.city} ${c.country} ${c.region}`).toLowerCase().includes(q));
  }

  const sort = $("#sort").value;
  const sorters = {
    pctAsc: (a,b)=> (a._pct??Infinity) - (b._pct??Infinity),
    pctDesc:(a,b)=> (b._pct??-Infinity) - (a._pct??-Infinity),
    costAsc:(a,b)=> a._cost - b._cost,
    costDesc:(a,b)=> b._cost - a._cost
  };
  rows.sort(sorters[sort] || sorters.pctAsc);
  return rows;
}

/* Build details breakdown that matches what's shown above */
function breakdownHTML(c){
  const total = c._cost;
  const rent = c._rent;
  const remaining = Math.max(0, total - rent);

  // Split remaining across Food, Utilities, Transit, Other in 2:1:1:2 ratio
  const wFood=2, wUtil=1, wTran=1, wOther=2, wSum=6;
  const food   = Math.round(remaining * (wFood / wSum));
  const util   = Math.round(remaining * (wUtil / wSum));
  const tran   = Math.round(remaining * (wTran / wSum));
  const other  = Math.max(0, total - (rent + food + util + tran)); // absorb rounding

  return `
    <div class="mini" style="margin-bottom:6px">Breakdown (housing uses the actual rent above)</div>
    <div class="rows" style="margin-top:0">
      <div class="row"><div class="k">Housing (rent)</div><div class="v">${money(rent)}/mo</div></div>
      <div class="row"><div class="k">Food</div><div class="v">${money(food)}/mo</div></div>
      <div class="row"><div class="k">Utilities</div><div class="v">${money(util)}/mo</div></div>
      <div class="row"><div class="k">Transit</div><div class="v">${money(tran)}/mo</div></div>
      <div class="row"><div class="k">Other</div><div class="v">${money(other)}/mo</div></div>
    </div>
  `;
}

/* Card UI */
function card(c){
  const top = (c._pct!=null) ? `${Math.round(c._pct)}% of income` : `Cost: ${money(c._cost)}/mo`;
  const sd  = (c._surplus!=null) ? (c._surplus>=0 ? `Surplus ${money(c._surplus)}/mo` : `Deficit ${money(Math.abs(c._surplus))}/mo`) : "—";
  return `
  <article class="card" data-id="${c.id}" tabindex="0" aria-label="${c.city}, ${c.country}">
    <div class="img">
      <img src="${c.image}" alt="${c.city}, ${c.country}" loading="lazy" decoding="async" />
      <div class="chip">${top}</div>
    </div>
    <div class="body">
      <div class="title">
        <h3>${c.city}, ${c.country}</h3>
        <span class="mini">${c.region}</span>
      </div>
      <div class="rows">
        <div class="row">
          <div class="k">${household==="single" ? "Monthly cost (single)" : "Monthly cost (two)"}</div>
          <div class="v">${money(c._cost)}/mo</div>
        </div>
        <div class="row">
          <div class="k">${bedrooms==="1" ? "1-bedroom rent" : "2-bedroom rent"}</div>
          <div class="v">${money(c._rent)}/mo</div>
        </div>
      </div>
      <div class="details">
        ${breakdownHTML(c)}
        <div style="margin-top:10px">
          <span class="pill">Household: ${household==="single"?"Single":"Two"}</span>
          <span class="pill">Bedrooms: ${bedrooms}</span>
          <span class="pill">${sd}</span>
        </div>
      </div>
    </div>
  </article>`;
}

/* Render — preserves open cards across updates */
function render(){
  const app = $("#app");

  // Remember open cards by data-id before re-render
  const openIDs = Array.from(document.querySelectorAll(".card.open")).map(c => c.dataset.id);

  const rows = computeRows();
  if(!rows.length){
    app.innerHTML = `<div class="empty">No results. Clear search or adjust inputs.</div>`;
    $("#summary").textContent = "Showing 0 cities";
    return;
  }
  app.innerHTML = `<section class="grid">${rows.map(card).join("")}</section>`;
  $("#summary").textContent = `Showing ${rows.length} ${rows.length===1?"city":"cities"}`;

  // Restore open state
  openIDs.forEach(id => {
    const el = app.querySelector(`.card[data-id="${id}"]`);
    if (el) el.classList.add("open");
  });
}

/* Toggle helpers */
function setHousehold(next){
  household = next;
  $("#btnSingle").setAttribute("aria-pressed", String(next==="single"));
  $("#btnTwo").setAttribute("aria-pressed", String(next==="two"));
  render();
}
function setBedrooms(next){
  bedrooms = next;
  $("#btn1BR").setAttribute("aria-pressed", String(next==="1"));
  $("#btn2BR").setAttribute("aria-pressed", String(next==="2"));
  render();
}

/* Events */
window.addEventListener("click", (e)=>{
  const card = e.target.closest(".card");
  if(card){ card.classList.toggle("open"); }
});
["income","search","sort"].forEach(id=>{
  const el = $("#"+id);
  el.addEventListener("input", render);
  el.addEventListener("change", render);
});
$("#btnSingle").addEventListener("click", ()=> setHousehold("single"));
$("#btnTwo").addEventListener("click",   ()=> setHousehold("two"));
$("#btn1BR").addEventListener("click",   ()=> setBedrooms("1"));
$("#btn2BR").addEventListener("click",   ()=> setBedrooms("2"));

/* Keyboard: Enter toggles card, '/' focuses search */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    const card = document.activeElement.closest?.(".card");
    if(card){ e.preventDefault(); card.classList.toggle("open"); }
  }
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement.tagName)){
    e.preventDefault(); $("#search").focus();
  }
});
</script>
</body>
</html>
