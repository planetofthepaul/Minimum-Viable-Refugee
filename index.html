<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Primary Meta Tags -->
<title>Minimum Viable Expat - Compare Cost of Living in 170+ Cities Worldwide</title>
<meta name="title" content="Minimum Viable Expat - Compare Cost of Living in 170+ Cities Worldwide" />
<meta name="description" content="Calculate how livable cities are based on your income. Compare rent, living costs, and affordability across 170+ cities worldwide for singles and couples." />
<meta name="keywords" content="cost of living, city comparison, rent calculator, expat, digital nomad, relocation, affordable cities, living expenses" />
<meta name="author" content="Minimum Viable Expat" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://minimumviableexpat.com/" />
<meta property="og:title" content="Minimum Viable Expat - Compare Cost of Living in 170+ Cities" />
<meta property="og:description" content="Calculate how livable cities are based on your income. Compare rent and living costs across 170+ cities worldwide." />
<meta property="og:image" content="https://minimumviableexpat.com/og-image.jpg" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="https://minimumviableexpat.com/" />
<meta property="twitter:title" content="Minimum Viable Expat - Compare Cost of Living" />
<meta property="twitter:description" content="Calculate how livable cities are based on your income. Compare 170+ cities worldwide." />
<meta property="twitter:image" content="https://minimumviableexpat.com/og-image.jpg" />

<!-- Canonical URL -->
<link rel="canonical" href="https://minimumviableexpat.com/" />

<!-- Favicon -->
<link rel="icon" type="image/png" href="/logo-mve.png">

<!-- Privacy-friendly analytics by Plausible -->
<script async src="https://plausible.io/js/pa-LtfPK73TbS61OwXTI4wmz.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>

<style>
  :root{
    --bg:#0b0e13; --surface:#0f1420; --text:#eaf1ff; --muted:#a9b3c7;
    --brand:#6aa8ff; --brand2:#8cffd1; --line:#1a2336; --card:#11182a;
    --chip:#182033; --shadow:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,14,19,.98),rgba(11,14,19,.7) 60%,rgba(11,14,19,0));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .h-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand a{color:inherit;text-decoration:none}
  .nav{display:flex;gap:16px;font-size:14px}
  .nav a{color:var(--muted);text-decoration:none;transition:color 0.2s}
  .nav a:hover{color:var(--text)}
  .badge{
    width:26px;
    height:26px;
    border-radius:6px;
    display:grid;
    place-items:center;
    background:none;
    color:inherit;
  }
  .badge img,
  .badge-img {
    width: 26px;
    height: 26px;
    border-radius: 6px;
    display: block;
  }

  /* Hero Section */
  .hero{
    position:relative;
    height:60vh;
    min-height:400px;
    max-height:600px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    margin-bottom:0;
  }
  .hero-bg{
    position:absolute;
    inset:0;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    background-image:url('https://images.unsplash.com/photo-1652088241116-5faf85b6c6aa?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
    background-size:cover;
    background-position:center;
  }
  .hero-overlay{
    position:absolute;
    inset:0;
    background:linear-gradient(180deg, rgba(11,14,19,0.3) 0%, rgba(11,14,19,0.8) 100%);
  }
  .hero-content{
    position:relative;
    z-index:2;
    text-align:center;
    padding:24px;
    max-width:800px;
  }
  .hero h1{
    font-size:clamp(32px, 6vw, 56px);
    margin:0 0 16px;
    line-height:1.1;
    font-weight:800;
    background:linear-gradient(135deg, var(--brand2) 0%, var(--brand) 100%);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  @keyframes blink {
    50% { opacity:0; }
  }
  .hero p{
    font-size:clamp(16px, 2vw, 20px);
    color:var(--text);
    margin:0;
    opacity:0.95;
  }
  @keyframes bounceUp {
    0% { opacity:0; transform:translateY(20px); }
    60% { opacity:1; transform:translateY(-5px); }
    100% { opacity:1; transform:translateY(0); }
  }

  /* First card pulsating badge */
  .first-card-badge{
    position:absolute;
    top:10px;
    left:10px;
    background:#ff9500;
    color:#fff;
    padding:10px 18px;
    border-radius:8px;
    font-size:13px;
    font-weight:700;
    letter-spacing:0.02em;
    box-shadow:0 4px 12px rgba(0,0,0,0.4);
    z-index:3;
    animation:strongPulse 2s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes strongPulse {
    0%, 100% { transform:scale(1); box-shadow:0 4px 12px rgba(0,0,0,0.4); }
    50% { transform:scale(1.08); box-shadow:0 6px 20px rgba(255,149,0,0.6); }
  }

  .filter-toggle{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    font-size:13px;
    padding:6px 12px;
    border-radius:999px;
    border:1px solid #22324d;
    background:#0c121f;
    color:var(--muted);
    cursor:pointer;
    white-space:nowrap;
  }
  .filter-toggle-main{
    margin-left:12px;
  }
  .filter-toggle-bottom{
    width:100%;
    margin-top:6px;
    background:#182033;
    color:#eaf1ff;
    border-color:#2b3a5a;
    font-weight:600;
  }

  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;padding:32px 16px 18px;background:var(--bg);position:relative}
  .controls.is-hidden{display:none;}

  .f{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:10px}
  .f label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .f input,.f select{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #22324d;
    background:#0c121f;
    color:#fff;
    font-size:16px; /* prevent mobile zoom */
  }
  .seg{display:flex;gap:8px;justify-content:center}
  .seg button{flex:1;padding:10px;border-radius:8px;border:1px solid #22324d;background:#0c121f;color:#d7e6ff;cursor:pointer;text-align:center}
  .seg button[aria-pressed="true"]{background:#1a2742}
  .mini{font-size:12px;color:var(--muted)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:12px 0 70px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    box-shadow:var(--shadow);
    cursor:pointer;
    display:flex;
    flex-direction:column;
  }
  .img{aspect-ratio:16/9;background:#0e1526;position:relative}
  .img img{width:100%;height:100%;object-fit:cover;display:block}
  .chip{position:absolute;left:10px;top:10px;background:rgba(10,16,28,.8);border:1px solid #1f2b46;border-radius:999px;padding:6px 10px;font-size:12px}
  .body{padding:14px}
  .title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .title h3{margin:0;font-size:18px}
  .rows{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .row{background:#0c121f;border:1px solid #1b2742;border-radius:10px;padding:10px}
  .k{font-size:12px;color:var(--muted)}
  .v{margin-top:4px;font-weight:700}

  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #2a3654;border-radius:12px;background:#0c121f}
  footer{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(11,14,19,.98),rgba(11,14,19,.6));border-top:1px solid var(--line)}
  .foot{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .sum{font-size:13px;color:var(--muted)}

  /* Full-screen city overlay */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(5,8,15,0.96);
    backdrop-filter:blur(10px);
    z-index:40;
    display:none;
    overflow-y:auto;
    padding:16px;
  }
  .overlay.open{
    display:block;
  }
  .overlay-inner{
    max-width:900px;
    margin:0 auto;
    background:var(--surface);
    border-radius:16px;
    border:1px solid var(--line);
    box-shadow:var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .overlay-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 16px;
    border-bottom:1px solid var(--line);
    background:rgba(11,14,19,0.92);
  }
  .overlay-header-left{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .overlay-close{
    border:none;
    background:#151b29;
    color:var(--muted);
    width:30px;
    height:30px;
    border-radius:999px;
    font-size:18px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .overlay-close:hover{
    background:#1f283a;
    color:var(--text);
  }
  .overlay-city{
    font-size:22px;
    font-weight:700;
  }
  .overlay-region{
    margin-top:2px;
  }
  .overlay-media{
    position:relative;
    aspect-ratio:16/6; /* shorter hero */
    background:#0e1526;
  }
  .overlay-media img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  .overlay-body{
    padding:16px 18px 18px;
  }

  /* updated breakdown styles */
  .break-heading{
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:0.06em;
    color:var(--muted);
    margin-bottom:6px;
  }

  .break-section{
    margin-top:4px;
  }
  .primary-total{
    padding:10px 0 12px;
    border-bottom:1px solid var(--line);
    margin-bottom:10px;
  }
  .primary-total .k{
    font-size:12px;
    color:var(--muted);
  }
  .primary-total .v{
    margin-top:4px;
    font-size:22px;
    font-weight:700;
  }
  .primary-total .sub{
    margin-top:4px;
    font-size:12px;
    color:var(--muted);
  }

  .break-list{
    list-style:none;
    margin:0;
    padding:0;
  }
  .break-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 0;
    border-bottom:1px solid #151b26;
    font-size:14px;
  }
  .break-item:last-child{
    border-bottom:none;
  }
  .break-item-label{
    color:var(--muted);
  }
  .break-item-value{
    font-weight:600;
  }

  .city-links{
    margin-top:16px;
  }
  .city-links-title{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .city-links ul{
    list-style:none;
    padding:0;
    margin:0;
  }
  .city-links li{
    margin-bottom:4px;
  }
  .city-links a{
    font-size:14px;
    color:var(--brand2); /* match logo accent, not default blue */
    text-decoration:none;
  }
  .city-links a:hover{
    text-decoration:underline;
  }

  @media (max-width:1024px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .f{grid-column:span 6}
  }

  @media (max-width:680px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .f{grid-column:span 12}

    .body{padding:10px}
    .title h3{font-size:14px}
    .title .mini{display:none}

    .card > .body > .rows{
      grid-template-columns:1fr;
      gap:8px;
      margin-top:8px;
    }
    .card > .body > .rows .row:nth-child(2){
      display:none;
    }
    .card > .body > .rows .row .k{
      display:none;
    }
    .card > .body > .rows .row .v{
      font-size:14px;
    }

    .overlay-inner{
      border-radius:12px;
    }
    .overlay-body{
      padding:14px;
    }
  }
</style>

<!-- Schema.org structured data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Minimum Viable Expat",
  "applicationCategory": "FinanceApplication",
  "description": "Calculate and compare cost of living across 170+ cities worldwide based on your income.",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
</head>
<body>
<!-- Top Navigation -->
<header>
  <div class="h-row wrap">
    <div class="brand">
      <a href="/">
        <div class="badge">
          <img src="logo-mve.png" alt="Minimum Viable Expat logo" class="badge-img">
        </div>
      </a>
      <a href="/">Minimum Viable Expat</a>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <nav class="nav">
        <a href="https://minimumviableexpat.com/about">About</a>
        <a href="https://minimumviableexpat.com/terms">Terms</a>
      </nav>
      <button class="filter-toggle filter-toggle-main" id="filterToggleTop" type="button" aria-expanded="true">
        Hide filters
      </button>
    </div>
  </div>
</header>

<!-- Hero Section -->
<section class="hero">
  <div class="hero-bg"></div>
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1>Explore Your Next Chapter</h1>
    <p>Compare cost of living across 230+ cities worldwide and find where your income takes you furthest</p>
  </div>
</section>

<!-- Filters Section -->
<section>
  <div class="controls wrap" role="region" aria-label="Controls">
    <div class="f" style="grid-column:span 4">
      <label for="income">Your monthly income (USD)</label>
      <input id="income" type="number" min="0" step="50" value="3000" />
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Household size</label>
      <div class="seg" role="group" aria-label="Household">
        <button id="btnSingle" aria-pressed="true">One</button>
        <button id="btnTwo" aria-pressed="false">Two</button>
      </div>
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Apartment size</label>
      <div class="seg" role="group" aria-label="Bedrooms">
        <button id="btn1BR" aria-pressed="true">1BR</button>
        <button id="btn2BR" aria-pressed="false">2BR</button>
      </div>
    </div>

    <div class="f" style="grid-column:span 8">
      <label for="search">Search</label>
      <input id="search" type="search" placeholder="Search cities or countries…" />
    </div>

    <div class="f" style="grid-column:span 4">
      <label for="sort">Sort</label>
      <select id="sort">
        <option value="editorChoice">Editor's Choice</option>
        <option value="withinBudget">Within my budget</option>
        <option value="costAsc">Lowest total cost</option>
        <option value="costDesc">Highest total cost</option>
      </select>
    </div>

    <!-- Bottom full-width hide/show filters button -->
    <div style="grid-column:1 / -1;display:flex;justify-content:flex-end;">
      <button class="filter-toggle filter-toggle-bottom" id="filterToggleBottom" type="button" aria-expanded="true">
        Hide filters
      </button>
    </div>
  </div>
</section>

<main class="wrap" id="app" aria-live="polite"></main>

<!-- Full-screen city overlay -->
<aside id="cityOverlay" class="overlay" aria-hidden="true"></aside>

<footer>
  <div class="foot">
    <div class="sum" id="summary">Showing results</div>
    <div class="mini">Tip: press <strong>/</strong> to focus search</div>
  </div>
</footer>

<script>
// ----------------- Ad Configuration -----------------
const ADS = {
  card1: {
    enabled: true,
    position: 3, // Desktop: position 3 (end of first row in 3-col), Mobile: position 4 (end of second row in 2-col)
    title: "Support a Good Cause",
    image: "wck-logo1.jpg",
    description: "Providing meals to communities affected by natural disasters and crises worldwide",
    link: "https://wck.org",
    label: "Featured Charity"
  },
  card2: {
    enabled: true,
    repeating: true, // This ad repeats every 20 cards
    interval: 20,    // Repeat every 20 cards
    title: "Learn the Language with Duolingo",
    image: "duolingo-placeholder.png",
    description: "Start learning before you go. Free lessons in 40+ languages to help you connect with locals.",
    link: "https://www.duolingo.com",
    label: "Language Learning"
  },
  overlayBanner: {
    enabled: true,
    html: `
      <div style="margin-top:20px;padding:16px;background:#0c121f;border:1px solid #1b2742;border-radius:10px;text-align:center;">
        <div style="font-size:11px;color:#6b7280;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Sponsored</div>
        <a href="https://example.com" target="_blank" rel="noopener" style="color:var(--brand2);text-decoration:none;font-size:14px;">
          Your Message Here - 728x90 or Custom
        </a>
      </div>
    `
  }
};

// ----------------- Data load -----------------
let CITIES = [];
let CITY_ELEMENTS = new Map(); // Store DOM elements for reuse

fetch('cities.json')
  .then(r => r.json())
  .then(async data => {
    CITIES = data;
    await preloadImages();   // load each city's image once
    render();
  })
  .catch(err => {
    console.error('Failed to load cities.json', err);
    document.querySelector('#app').innerHTML =
      '<div class="empty">Could not load cities.json. Make sure it exists in the repo root.</div>';
    document.querySelector('#summary').textContent = "Showing 0 cities";
  });

// ----------------- State & helpers -----------------
const $ = s => document.querySelector(s);
const money = x => `$${Math.round(x).toLocaleString()}`;

const FALLBACK_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900">
    <rect width="100%" height="100%" fill="#0e1526"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          fill="#2a3654" font-family="system-ui, sans-serif" font-size="36">image unavailable</text>
  </svg>
`);
const IMG_CACHE = new Map();

let household = "single";
let bedrooms  = "1";
let LAST_ROWS = [];

function currentRent(c){ return bedrooms === "1" ? c.rent1BR : c.rent2BR; }

function currentCost(c){
  const baseTotal = (household === "single") ? c.costOne : c.costTwo;
  const baselineRent = (household === "single") ? c.rent1BR : c.rent2BR;
  const selectedRent = currentRent(c);
  return baseTotal - baselineRent + selectedRent;
}

function computeRows(){
  const income = +$("#income").value || 0;
  const q = ($("#search").value || "").trim().toLowerCase();

  let rows = CITIES.map(c=>{
    const cost = currentCost(c);
    const rent = currentRent(c);
    const pct = income>0 ? (cost / income) * 100 : null;
    const surplus = income>0 ? (income - cost) : null;
    return {...c, _cost:cost, _rent:rent, _pct:pct, _surplus:surplus};
  });

  if(q){
    rows = rows.filter(c => (`${c.city} ${c.country} ${c.region}`).toLowerCase().includes(q));
  }

  const sort = $("#sort").value;
  const sorters = {
    editorChoice:(a,b)=> {
      const aRank = a.editorRank || 999;
      const bRank = b.editorRank || 999;
      // If both have ranks, sort by rank
      if (aRank !== 999 && bRank !== 999) return aRank - bRank;
      // If only one has a rank, it comes first
      if (aRank !== 999) return -1;
      if (bRank !== 999) return 1;
      // If neither has a rank, sort by cost
      return a._cost - b._cost;
    },
    withinBudget:(a,b)=> {
      // Filter happens below, this just sorts high to low
      return b._cost - a._cost;
    },
    costAsc:(a,b)=> a._cost - b._cost,
    costDesc:(a,b)=> b._cost - a._cost
  };
  
  // Filter out cities over budget if "Within my budget" is selected
  if (sort === "withinBudget" && income > 0) {
    rows = rows.filter(c => c._cost <= income);
  }
  
  rows.sort(sorters[sort] || sorters.editorChoice);
  return rows;
}

async function wikiThumbActionAPI(title){
  const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original|thumbnail&pithumbsize=1280&titles=${encodeURIComponent(title)}&origin=*`;
  const r = await fetch(url);
  if(!r.ok) return null;
  const j = await r.json();
  const pages = j?.query?.pages || {};
  const first = Object.values(pages)[0];
  if(!first) return null;
  return first.original?.source || first.thumbnail?.source || null;
}

async function resolveCityImage(city, country, explicit){
  if (explicit) return explicit;

  const key = `${city}|${country}`;
  if(IMG_CACHE.has(key)) return IMG_CACHE.get(key);

  let src = await wikiThumbActionAPI(`${city}, ${country}`);
  if(!src) src = await wikiThumbActionAPI(city);
  if(!src) src = FALLBACK_IMG;

  IMG_CACHE.set(key, src);
  return src;
}

// Preload images ONCE so filters don't re-trigger loading
async function preloadImages(){
  const promises = CITIES.map(async c => {
    const key = `${c.city}|${c.country}`;
    if(c.image){
      IMG_CACHE.set(key, c.image);
      c._img = c.image;
    }else{
      const src = await resolveCityImage(c.city, c.country, null);
      IMG_CACHE.set(key, src);
      c._img = src;
    }
  });
  await Promise.all(promises);
}

// Breakdown for overlay: one clear primary total + simple list
function breakdownHTML(c){
  const total = c._cost;
  const rent = c._rent;
  const remaining = Math.max(0, total - rent);

  const wFood=2, wUtil=1, wTran=1, wOther=2, wSum=6;
  const food   = Math.round(remaining * (wFood / wSum));
  const util   = Math.round(remaining * (wUtil / wSum));
  const tran   = Math.round(remaining * (wTran / wSum));
  const other  = Math.max(0, total - (rent + food + util + tran));

  const pctLabel = c._pct != null ? `${Math.round(c._pct)}% of your income` : '';

  return `
    <div class="break-section">
      <div class="break-heading">Monthly breakdown</div>
      <div class="primary-total">
        <div class="k">${household==="single" ? "Total monthly cost (single)" : "Total monthly cost (two)"}</div>
        <div class="v">${money(total)}/mo</div>
        ${pctLabel ? `<div class="sub">${pctLabel}</div>` : ''}
      </div>
      <ul class="break-list">
        <li class="break-item">
          <span class="break-item-label">${bedrooms==="1" ? "1-bedroom rent" : "2-bedroom rent"}</span>
          <span class="break-item-value">${money(rent)}/mo</span>
        </li>
        <li class="break-item">
          <span class="break-item-label">Food</span>
          <span class="break-item-value">${money(food)}/mo</span>
        </li>
        <li class="break-item">
          <span class="break-item-label">Utilities</span>
          <span class="break-item-value">${money(util)}/mo</span>
        </li>
        <li class="break-item">
          <span class="break-item-label">Transit</span>
          <span class="break-item-value">${money(tran)}/mo</span>
        </li>
        <li class="break-item">
          <span class="break-item-label">Other</span>
          <span class="break-item-value">${money(other)}/mo</span>
        </li>
      </ul>
    </div>
  `;
}

function createCardElement(c){
  const top = (c._pct!=null) ? `${Math.round(c._pct)}% of income` : `Cost: ${money(c._cost)}/mo`;
  const imgSrc = c._img || FALLBACK_IMG;

  const article = document.createElement('article');
  article.className = 'card';
  article.dataset.id = c.id;
  article.dataset.city = c.city;
  article.dataset.country = c.country;
  article.tabIndex = 0;
  article.setAttribute('aria-label', `${c.city}, ${c.country}`);
  
  article.innerHTML = `
    <div class="img">
      <img alt="${c.city}, ${c.country}" src="${imgSrc}" loading="lazy" decoding="async" />
      <div class="chip">${top}</div>
    </div>
    <div class="body">
      <div class="title">
        <h3>${c.city}, ${c.country}</h3>
        <span class="mini">${c.region}</span>
      </div>
      <div class="rows">
        <div class="row">
          <div class="k">${household==="single" ? "Monthly cost (single)" : "Monthly cost (two)"}</div>
          <div class="v">${money(c._cost)}/mo</div>
        </div>
        <div class="row">
          <div class="k">${bedrooms==="1" ? "1-bedroom rent" : "2-bedroom rent"}</div>
          <div class="v">${money(c._rent)}/mo</div>
        </div>
      </div>
    </div>`;
  
  return article;
}

function createAdCard(ad){
  const article = document.createElement('article');
  article.className = 'card';
  article.dataset.isAd = 'true';
  article.style.cursor = 'pointer';
  
  // Determine if this is a sponsored ad or featured charity
  const isCharity = ad.label === "Featured Charity";
  const labelText = isCharity ? ad.label : "SPONSORED";
  const labelStyle = isCharity 
    ? "position:absolute;top:10px;left:10px;background:rgba(10,16,28,.95);border:1px solid #8cffd1;color:#8cffd1;border-radius:999px;padding:6px 10px;font-size:12px;"
    : "position:absolute;top:10px;left:10px;font-size:10px;font-weight:600;letter-spacing:0.08em;color:#6b7280;text-transform:uppercase;";
  
  article.innerHTML = `
    <a href="${ad.link}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit;display:flex;flex-direction:column;height:100%;">
      <div class="img">
        <img alt="${ad.title}" src="${ad.image}" loading="lazy" decoding="async" />
        <div style="${labelStyle}">${labelText}</div>
      </div>
      <div class="body">
        <div class="title">
          <h3 style="font-size:16px;">${ad.title}</h3>
        </div>
        <div style="margin-top:8px;font-size:13px;color:var(--muted);line-height:1.4;">
          ${ad.description}
        </div>
      </div>
    </a>`;
  
  return article;
}

function createDividerElement(){
  const divider = document.createElement('div');
  divider.className = 'editor-divider';
  divider.dataset.isDivider = 'true';
  divider.style.gridColumn = '1 / -1';
  divider.style.margin = '20px 0';
  divider.style.padding = '20px';
  divider.style.background = 'var(--surface)';
  divider.style.border = '1px solid var(--line)';
  divider.style.borderRadius = '12px';
  divider.style.textAlign = 'center';
  
  divider.innerHTML = `
    <div style="font-size:14px;font-weight:600;color:var(--text);margin-bottom:4px;">
      ⬆️ Editor's Choice ⬆️
    </div>
    <div style="font-size:13px;color:var(--muted);">
      Below sorted by lowest cost
    </div>`;
  
  return divider;
}

function updateCardElement(cardEl, c){
  const top = (c._pct!=null) ? `${Math.round(c._pct)}% of income` : `Cost: ${money(c._cost)}/mo`;
  
  cardEl.querySelector('.chip').textContent = top;
  
  const rowEls = cardEl.querySelectorAll('.row');
  rowEls[0].querySelector('.k').textContent = household==="single" ? "Monthly cost (single)" : "Monthly cost (two)";
  rowEls[0].querySelector('.v').textContent = `${money(c._cost)}/mo`;
  rowEls[1].querySelector('.k').textContent = bedrooms==="1" ? "1-bedroom rent" : "2-bedroom rent";
  rowEls[1].querySelector('.v').textContent = `${money(c._rent)}/mo`;
}

function render(){
  const app = $("#app");

  const rows = computeRows();
  LAST_ROWS = rows;

  if(!rows.length){
    app.innerHTML = `<div class="empty">No results. Clear search or adjust inputs.</div>`;
    $("#summary").textContent = "Showing 0 cities";
    return;
  }
  
  let gridEl = app.querySelector('.grid');
  if (!gridEl) {
    gridEl = document.createElement('section');
    gridEl.className = 'grid';
    app.innerHTML = '';
    app.appendChild(gridEl);
  }
  
  // Build array of items (cities + ads) by inserting ads at specific positions
  const items = [];
  let cityIndex = 0;
  let position = 1;
  
  // Detect if we're on mobile (2 columns) or desktop (3 columns)
  const isMobile = window.innerWidth <= 680;
  const columns = isMobile ? 2 : 3;
  const wckPosition = isMobile ? 4 : 3; // Position 4 on mobile (end of row 2), position 3 on desktop (end of row 1)
  
  // Check if we're in Editor's Choice mode
  const isEditorChoice = $("#sort").value === "editorChoice";
  let editorChoiceDividerInserted = false;
  
  while (cityIndex < rows.length) {
    // Insert divider after the 20th ranked city
    if (isEditorChoice && !editorChoiceDividerInserted && cityIndex === 20) {
      items.push({ type: 'divider', id: 'editor-choice-divider' });
      editorChoiceDividerInserted = true;
    }
    
    // Check if WCK should be placed at this position
    if (ADS.card1.enabled && position === wckPosition) {
      items.push({ type: 'ad', data: ADS.card1, id: 'ad-card1' });
      position++;
      continue;
    }
    
    // Check if Duolingo should be placed (every 20 cards, rightmost column)
    if (ADS.card2.enabled && ADS.card2.repeating && cityIndex > 0 && cityIndex % ADS.card2.interval === 0) {
      // Calculate if we need to add filler cities to reach rightmost column
      const currentRow = Math.floor((position - 1) / columns);
      const positionInRow = (position - 1) % columns;
      const rightmostColumn = columns - 1;
      
      // Add cities until we reach the rightmost column
      while (positionInRow < rightmostColumn && cityIndex < rows.length) {
        items.push({ type: 'city', data: rows[cityIndex], id: String(rows[cityIndex].id) });
        cityIndex++;
        position++;
        const newPositionInRow = (position - 1) % columns;
        if (newPositionInRow === rightmostColumn) break;
      }
      
      // Now place the ad in rightmost column
      const adId = `ad-card2-${Math.floor(cityIndex / ADS.card2.interval)}`;
      items.push({ type: 'ad', data: ADS.card2, id: adId });
      position++;
      continue;
    }
    
    // Place a city card
    if (cityIndex < rows.length) {
      items.push({ type: 'city', data: rows[cityIndex], id: String(rows[cityIndex].id) });
      cityIndex++;
    }
    position++;
    
    // Safety break
    if (position > 10000) break;
  }
  
  // Build set of current IDs
  const currentIds = new Set(items.map(item => item.id));
  
  // Remove elements that shouldn't be shown
  Array.from(gridEl.children).forEach(el => {
    let elId;
    if (el.dataset.isDivider === 'true') {
      elId = el.dataset.dividerId;
    } else if (el.dataset.isAd === 'true') {
      elId = el.dataset.adId;
    } else {
      elId = el.dataset.id;
    }
    
    if (!currentIds.has(elId)) {
      if (el.dataset.isAd !== 'true' && el.dataset.isDivider !== 'true') {
        CITY_ELEMENTS.delete(elId);
      }
      el.remove();
    }
  });
  
  // Add or update items
  items.forEach((item, index) => {
    let element;
    
    if (item.type === 'divider') {
      // Check if divider already exists
      element = gridEl.querySelector(`[data-divider-id="${item.id}"]`);
      if (!element) {
        element = createDividerElement();
        element.dataset.dividerId = item.id;
      }
    } else if (item.type === 'ad') {
      // Check if ad card already exists
      element = gridEl.querySelector(`[data-ad-id="${item.id}"]`);
      if (!element) {
        element = createAdCard(item.data);
        element.dataset.adId = item.id;
      }
    } else {
      // City card
      element = CITY_ELEMENTS.get(item.id);
      if (!element) {
        element = createCardElement(item.data);
        CITY_ELEMENTS.set(item.id, element);
      } else {
        updateCardElement(element, item.data);
      }
    }
    
    // Ensure correct position in grid
    if (gridEl.children[index] !== element) {
      if (index >= gridEl.children.length) {
        gridEl.appendChild(element);
      } else {
        gridEl.insertBefore(element, gridEl.children[index]);
      }
    }
  });
  
  $("#summary").textContent = `Showing ${rows.length} ${rows.length===1?"city":"cities"}`;
}

// -------- Full-screen overlay logic --------
const overlayEl = document.getElementById('cityOverlay');

function closeCityDetail(){
  overlayEl.classList.remove('open');
  overlayEl.setAttribute('aria-hidden','true');
  overlayEl.innerHTML = '';
  document.body.style.overflow = '';
}

function openCityDetail(id, cardEl){
  const city = LAST_ROWS.find(c => String(c.id) === String(id));
  if(!city) return;

  const imgSrc = city._img || FALLBACK_IMG;
  const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(city.city.replace(/ /g, "_"))}`;
  const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(city.city + ', ' + city.country)}`;

  const pctLabel = city._pct != null ? `${Math.round(city._pct)}% of your income` : '';

  overlayEl.innerHTML = `
    <div class="overlay-inner">
      <div class="overlay-header">
        <div class="overlay-header-left">
          <button class="overlay-close" type="button" data-close>&times;</button>
          <div>
            <div class="overlay-city">${city.city}, ${city.country}</div>
            <div class="overlay-region mini">${city.region}${pctLabel ? " · " + pctLabel : ""}</div>
          </div>
        </div>
      </div>
      <div class="overlay-media">
        <img src="${imgSrc}" alt="${city.city}, ${city.country}">
      </div>
      <div class="overlay-body">
        ${breakdownHTML(city)}
        <div class="city-links">
          <div class="city-links-title">Quick links</div>
          <ul>
            <li><a href="${wikiUrl}" target="_blank" rel="noopener">Open Wikipedia →</a></li>
            <li><a href="${mapsUrl}" target="_blank" rel="noopener">Open Google Maps →</a></li>
          </ul>
        </div>
        ${ADS.overlayBanner.enabled ? ADS.overlayBanner.html : ''}
      </div>
    </div>
  `;

  overlayEl.classList.add('open');
  overlayEl.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';

  const closeBtn = overlayEl.querySelector('[data-close]');
  if(closeBtn){
    closeBtn.addEventListener('click', closeCityDetail);
  }
}

// --- First card pulsating badge ---
let badgeAdded = false;
const baseRender = render;
render = function() {
  baseRender();
  
  if (!badgeAdded && !sessionStorage.getItem('mve_seen_first_card')) {
    setTimeout(() => {
      const firstCard = document.querySelector('.card[data-id]');
      
      if (firstCard && !firstCard.querySelector('.first-card-badge')) {
        badgeAdded = true;
        
        // Hide the regular chip on first card
        const chip = firstCard.querySelector('.chip');
        if (chip) chip.style.display = 'none';
        
        const badge = document.createElement('div');
        badge.className = 'first-card-badge';
        badge.textContent = 'Tap to explore';
        firstCard.style.position = 'relative';
        firstCard.querySelector('.img').appendChild(badge);
        firstCard.querySelector('.img').appendChild(badge);
        
        const removeBadge = () => {
          if (badge && badge.parentNode) {
            badge.remove();
            // Show the regular chip again
            if (chip) chip.style.display = '';
            sessionStorage.setItem('mve_seen_first_card', 'true');
          }
        };
        
        // Remove on any card click
        document.querySelectorAll('.card[data-id]').forEach(card => {
          card.addEventListener('click', removeBadge, { once: true });
        });
        
        // No auto-timeout - only removes when user clicks
      }
    }, 300);
  }
};

// Click to open overlay
window.addEventListener("click", (e)=>{
  const cardEl = e.target.closest(".card");
  if(cardEl && !overlayEl.contains(e.target)){
    // Don't open overlay for ad cards
    if (cardEl.dataset.isAd === 'true') {
      return;
    }
    const id = cardEl.dataset.id;
    openCityDetail(id, cardEl);
  }
});

// Filter + inputs
["income","search","sort"].forEach(id=>{
  const el = $("#"+id);
  el.addEventListener("input", render);
  el.addEventListener("change", render);
});
$("#btnSingle").addEventListener("click", ()=> {
  household="single";
  $("#btnSingle").setAttribute("aria-pressed","true");
  $("#btnTwo").setAttribute("aria-pressed","false");
  render();
});
$("#btnTwo").addEventListener("click", ()=> {
  household="two";
  $("#btnSingle").setAttribute("aria-pressed","false");
  $("#btnTwo").setAttribute("aria-pressed","true");
  render();
});
$("#btn1BR").addEventListener("click", ()=> {
  bedrooms="1";
  $("#btn1BR").setAttribute("aria-pressed","true");
  $("#btn2BR").setAttribute("aria-pressed","false");
  render();
});
$("#btn2BR").addEventListener("click", ()=> {
  bedrooms="2";
  $("#btn1BR").setAttribute("aria-pressed","false");
  $("#btn2BR").setAttribute("aria-pressed","true");
  render();
});

document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    const cardEl = document.activeElement.closest?.(".card");
    if(cardEl){
      e.preventDefault();
      openCityDetail(cardEl.dataset.id, cardEl);
    }
  }
  if(e.key==="Escape" && overlayEl.classList.contains('open')){
    closeCityDetail();
  }
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement.tagName)){
    e.preventDefault(); $("#search").focus();
  }
});

// Close overlay when clicking backdrop
overlayEl.addEventListener('click', (e)=>{
  if(e.target === overlayEl){
    closeCityDetail();
  }
});

// Re-render on window resize to handle mobile/desktop ad positioning
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    render();
  }, 250);
});

// --- Filter toggles: top pill + bottom button, synced ---
const controlsEl = document.querySelector('.controls');
const filterBtnTop = document.getElementById('filterToggleTop');
const filterBtnBottom = document.getElementById('filterToggleBottom');

function setFilterHidden(hidden){
  controlsEl.classList.toggle('is-hidden', hidden);
  const label = hidden ? 'Show filters' : 'Hide filters';
  [filterBtnTop, filterBtnBottom].forEach(btn => {
    if(!btn) return;
    btn.textContent = label;
    btn.setAttribute('aria-expanded', String(!hidden));
  });
}

filterBtnTop.addEventListener('click', () => {
  const currentlyHidden = controlsEl.classList.contains('is-hidden');
  setFilterHidden(!currentlyHidden);
});
filterBtnBottom.addEventListener('click', () => {
  const currentlyHidden = controlsEl.classList.contains('is-hidden');
  setFilterHidden(!currentlyHidden);
});
</script>
</body>
</html>
