<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<!-- Primary Meta Tags -->
<title>Minimum Viable Expat - Compare Cost of Living in 170+ Cities Worldwide</title>
<meta name="title" content="Minimum Viable Expat - Compare Cost of Living in 170+ Cities Worldwide" />
<meta name="description" content="Calculate how livable cities are based on your income. Compare rent, living costs, and affordability across 170+ cities worldwide for singles and couples." />
<meta name="keywords" content="cost of living, city comparison, rent calculator, expat, digital nomad, relocation, affordable cities, living expenses" />
<meta name="author" content="Minimum Viable Expat" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://minimumviableexpat.com/" />
<meta property="og:title" content="Minimum Viable Expat - Compare Cost of Living in 170+ Cities" />
<meta property="og:description" content="Calculate how livable cities are based on your income. Compare rent and living costs across 170+ cities worldwide." />
<meta property="og:image" content="https://minimumviableexpat.com/og-image.jpg" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content="https://minimumviableexpat.com/" />
<meta property="twitter:title" content="Minimum Viable Expat - Compare Cost of Living" />
<meta property="twitter:description" content="Calculate how livable cities are based on your income. Compare 170+ cities worldwide." />
<meta property="twitter:image" content="https://minimumviableexpat.com/og-image.jpg" />

<!-- Canonical URL -->
<link rel="canonical" href="https://minimumviableexpat.com/" />

<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⛑️</text></svg>" />

<style>
  :root{
    --bg:#0b0e13; --surface:#0f1420; --text:#eaf1ff; --muted:#a9b3c7;
    --brand:#6aa8ff; --brand2:#8cffd1; --line:#1a2336; --card:#11182a;
    --chip:#182033; --shadow:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,14,19,.98),rgba(11,14,19,.7) 60%,rgba(11,14,19,0));backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .h-row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .brand a{color:inherit;text-decoration:none}
  .nav{display:flex;gap:16px;font-size:14px}
  .nav a{color:var(--muted);text-decoration:none;transition:color 0.2s}
  .nav a:hover{color:var(--text)}
  .badge{width:26px;height:26px;border-radius:6px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#061018}

  .filter-toggle{
    display:flex;
    align-items:center;
    gap:6px;
    font-size:13px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #22324d;
    background:#0c121f;
    color:var(--muted);
    cursor:pointer;
    margin-left:12px;
    white-space:nowrap;
  }

  .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;padding:0 16px 14px}
  .controls.is-hidden{display:none;}

  .f{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:10px}
  .f label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .f input,.f select{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #22324d;
    background:#0c121f;
    color:#fff;
    font-size:16px; /* prevent mobile zoom */
  }
  .seg{display:flex;gap:8px}
  .seg button{flex:1;padding:10px;border-radius:8px;border:1px solid #22324d;background:#0c121f;color:#d7e6ff;cursor:pointer}
  .seg button[aria-pressed="true"]{background:#1a2742}
  .mini{font-size:12px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:12px 0 70px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    overflow:hidden;
    box-shadow:var(--shadow);
    cursor:pointer;
    display:flex;
    flex-direction:column;
  }
  .img{aspect-ratio:16/9;background:#0e1526;position:relative}
  .img img{width:100%;height:100%;object-fit:cover;display:block}
  .chip{position:absolute;left:10px;top:10px;background:rgba(10,16,28,.8);border:1px solid #1f2b46;border-radius:999px;padding:6px 10px;font-size:12px}
  .body{padding:14px}
  .title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .title h3{margin:0;font-size:18px}
  .rows{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .row{background:#0c121f;border:1px solid #1b2742;border-radius:10px;padding:10px}
  .k{font-size:12px;color:var(--muted)}
  .v{margin-top:4px;font-weight:700}
  .details{
    display:none;
    border-top:1px solid #1b2742;
    margin-top:12px;
    padding-top:12px;
    font-size:13px;
    line-height:1.4;
  }
  .card.open .details{display:block}
  .details .mini{font-size:11px;margin-bottom:6px}
  .details .rows{
    margin-top:6px;
    grid-template-columns:1fr 1fr;
    gap:8px;
  }
  .details .row{
    padding:8px 10px;
  }
  .details .k{font-size:11px}
  .details .v{font-size:13px;margin-top:2px}
  .pill{
    display:inline-block;
    background:var(--chip);
    border:1px solid #223055;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    margin-right:6px;
    margin-bottom:6px;
  }
  .empty{padding:40px;text-align:center;color:var(--muted);border:1px dashed #2a3654;border-radius:12px;background:#0c121f}
  footer{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(11,14,19,.98),rgba(11,14,19,.6));border-top:1px solid var(--line)}
  .foot{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .sum{font-size:13px;color:var(--muted)}

  @media (max-width:1024px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .f{grid-column:span 6}
  }

  @media (max-width:680px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .f{grid-column:span 12}

    .body{padding:10px}
    .title h3{font-size:14px}
    .title .mini{display:none}

    /* Compact top summary rows only (not breakdown) */
    .card > .body > .rows{
      grid-template-columns:1fr;
      gap:8px;
      margin-top:8px;
    }
    .card > .body > .rows .row:nth-child(2){
      display:none; /* hide rent row to keep card focused on monthly cost */
    }
    .card > .body > .rows .row .k{
      display:none; /* hide label, leave just the value */
    }
    .card > .body > .rows .row .v{
      font-size:14px;
    }

    /* Expanded details: full-width, readable, not cut off */
    .card .details{
      padding-top:10px;
      margin-top:10px;
      font-size:13px;
    }
    .card .details .rows{
      grid-template-columns:1fr; /* stack breakdown items vertically */
      gap:8px;
      margin-top:8px;
    }
    .card .details .row{
      padding:8px 10px;
    }
    .card .details .k{
      display:block;
      font-size:11px;
    }
    .card .details .v{
      margin-top:2px;
      font-size:13px;
    }
    .pill{
      font-size:11px;
      padding:5px 9px;
    }

    .chip{font-size:10px;padding:4px 8px}
  }
</style>

<!-- Schema.org structured data for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Minimum Viable Expat",
  "applicationCategory": "FinanceApplication",
  "description": "Calculate and compare cost of living across 170+ cities worldwide based on your income.",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script>
</head>
<body>
<header>
  <div class="h-row wrap">
    <div class="brand">
      <a href="/">
        <div class="badge">⛑️</div>
      </a>
      <a href="/">Minimum Viable Expat</a>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <nav class="nav">
        <a href="https://minimumviableexpat.com/about">About</a>
        <a href="https://minimumviableexpat.com/terms">Terms</a>
      </nav>
      <button class="filter-toggle" id="filterToggle" type="button" aria-expanded="true">
        Hide filters
      </button>
    </div>
  </div>

  <div class="controls wrap" role="region" aria-label="Controls">
    <div class="f" style="grid-column:span 4">
      <label for="income">Monthly take-home income (USD)</label>
      <input id="income" type="number" min="0" step="50" value="6000" />
      <div class="mini">We compute what share of that income each city would consume.</div>
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Household</label>
      <div class="seg" role="group" aria-label="Household">
        <button id="btnSingle" aria-pressed="true">Single</button>
        <button id="btnTwo" aria-pressed="false">Two</button>
      </div>
      <div class="mini">Affects the non-rent parts of the total.</div>
    </div>

    <div class="f" style="grid-column:span 4">
      <label>Bedrooms</label>
      <div class="seg" role="group" aria-label="Bedrooms">
        <button id="btn1BR" aria-pressed="true">1BR</button>
        <button id="btn2BR" aria-pressed="false">2BR</button>
      </div>
      <div class="mini">Affects rent only; total adjusts accordingly.</div>
    </div>

    <div class="f" style="grid-column:span 8">
      <label for="search">Search</label>
      <input id="search" type="search" placeholder="Search cities or countries…" />
    </div>

    <div class="f" style="grid-column:span 4">
      <label for="sort">Sort</label>
      <select id="sort">
        <option value="pctAsc">% of income ↑</option>
        <option value="pctDesc">% of income ↓</option>
        <option value="costAsc">Monthly cost ↑</option>
        <option value="costDesc">Monthly cost ↓</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap" id="app" aria-live="polite"></main>

<footer>
  <div class="foot">
    <div class="sum" id="summary">Showing results</div>
    <div class="mini">Tip: press <strong>/</strong> to focus search</div>
  </div>
</footer>

<script>
// ----------------- Data load -----------------
let CITIES = [];
fetch('cities.json')
  .then(r => r.json())
  .then(data => { CITIES = data; render(); })
  .catch(err => {
    console.error('Failed to load cities.json', err);
    document.querySelector('#app').innerHTML =
      '<div class="empty">Could not load cities.json. Make sure it exists in the repo root.</div>';
    document.querySelector('#summary').textContent = "Showing 0 cities";
  });

// ----------------- State & helpers -----------------
const $ = s => document.querySelector(s);
const money = x => `$${Math.round(x).toLocaleString()}`;

const FALLBACK_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900">
    <rect width="100%" height="100%" fill="#0e1526"/>
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
          fill="#2a3654" font-family="system-ui, sans-serif" font-size="36">image unavailable</text>
  </svg>
`);
const IMG_CACHE = new Map();

let household = "single";
let bedrooms  = "1";

function currentRent(c){ return bedrooms === "1" ? c.rent1BR : c.rent2BR; }

function currentCost(c){
  const baseTotal = (household === "single") ? c.costOne : c.costTwo;
  const baselineRent = (household === "single") ? c.rent1BR : c.rent2BR;
  const selectedRent = currentRent(c);
  return baseTotal - baselineRent + selectedRent;
}

function computeRows(){
  const income = +$("#income").value || 0;
  const q = ($("#search").value || "").trim().toLowerCase();

  let rows = CITIES.map(c=>{
    const cost = currentCost(c);
    const rent = currentRent(c);
    const pct = income>0 ? (cost / income) * 100 : null;
    const surplus = income>0 ? (income - cost) : null;
    return {...c, _cost:cost, _rent:rent, _pct:pct, _surplus:surplus};
  });

  if(q){
    rows = rows.filter(c => (`${c.city} ${c.country} ${c.region}`).toLowerCase().includes(q));
  }

  const sort = $("#sort").value;
  const sorters = {
    pctAsc: (a,b)=> (a._pct??Infinity) - (b._pct??Infinity),
    pctDesc:(a,b)=> (b._pct??-Infinity) - (a._pct??-Infinity),
    costAsc:(a,b)=> a._cost - b._cost,
    costDesc:(a,b)=> b._cost - a._cost
  };
  rows.sort(sorters[sort] || sorters.pctAsc);
  return rows;
}

async function wikiThumbActionAPI(title){
  const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=original|thumbnail&pithumbsize=1280&titles=${encodeURIComponent(title)}&origin=*`;
  const r = await fetch(url);
  if(!r.ok) return null;
  const j = await r.json();
  const pages = j?.query?.pages || {};
  const first = Object.values(pages)[0];
  if(!first) return null;
  return first.original?.source || first.thumbnail?.source || null;
}

async function resolveCityImage(city, country, explicit){
  if (explicit) return explicit;

  const key = `${city}|${country}`;
  if(IMG_CACHE.has(key)) return IMG_CACHE.get(key);

  let src = await wikiThumbActionAPI(`${city}, ${country}`);
  if(!src) src = await wikiThumbActionAPI(city);
  if(!src) src = FALLBACK_IMG;

  IMG_CACHE.set(key, src);
  return src;
}

async function hydrateImages(){
  const cards = Array.from(document.querySelectorAll('.card'));
  for (const el of cards){
    const img = el.querySelector('img[data-loaded="false"]');
    if(!img) continue;

    const city = el.dataset.city;
    const country = el.dataset.country;
    const explicit = el.dataset.explicit && el.dataset.explicit !== 'null' ? el.dataset.explicit : null;

    try{
      const src = await resolveCityImage(city, country, explicit);
      img.src = src || FALLBACK_IMG;
    }catch(e){
      img.src = FALLBACK_IMG;
    }
    img.setAttribute('data-loaded','true');
    img.onerror = () => { img.onerror = null; img.src = FALLBACK_IMG; };
  }
}

function breakdownHTML(c){
  const total = c._cost;
  const rent = c._rent;
  const remaining = Math.max(0, total - rent);

  const wFood=2, wUtil=1, wTran=1, wOther=2, wSum=6;
  const food   = Math.round(remaining * (wFood / wSum));
  const util   = Math.round(remaining * (wUtil / wSum));
  const tran   = Math.round(remaining * (wTran / wSum));
  const other  = Math.max(0, total - (rent + food + util + tran));

  return `
    <div class="mini">Breakdown (housing uses the actual rent above)</div>
    <div class="rows">
      <div class="row"><div class="k">Housing (rent)</div><div class="v">${money(rent)}/mo</div></div>
      <div class="row"><div class="k">Food</div><div class="v">${money(food)}/mo</div></div>
      <div class="row"><div class="k">Utilities</div><div class="v">${money(util)}/mo</div></div>
      <div class="row"><div class="k">Transit</div><div class="v">${money(tran)}/mo</div></div>
      <div class="row"><div class="k">Other</div><div class="v">${money(other)}/mo</div></div>
    </div>
  `;
}

function card(c){
  const top = (c._pct!=null) ? `${Math.round(c._pct)}% of income` : `Cost: ${money(c._cost)}/mo`;
  const sd  = (c._surplus!=null) ? (c._surplus>=0 ? `Surplus ${money(c._surplus)}/mo` : `Deficit ${money(Math.abs(c._surplus))}/mo`) : "—";
  const explicitImg = c.image ? c.image : "";

  const key = `${c.city}|${c.country}`;
  const cachedImg = IMG_CACHE.get(key);
  const imgSrc = cachedImg || '';
  const dataLoaded = cachedImg ? 'true' : 'false';

  return `
  <article class="card" data-id="${c.id}" data-city="${c.city}" data-country="${c.country}" data-explicit="${explicitImg}" tabindex="0" aria-label="${c.city}, ${c.country}">
    <div class="img">
      <img alt="${c.city}, ${c.country}" src="${imgSrc}" loading="lazy" decoding="async" data-loaded="${dataLoaded}" />
      <div class="chip">${top}</div>
    </div>
    <div class="body">
      <div class="title">
        <h3>${c.city}, ${c.country}</h3>
        <span class="mini">${c.region}</span>
      </div>
      <div class="rows">
        <div class="row">
          <div class="k">${household==="single" ? "Monthly cost (single)" : "Monthly cost (two)"}</div>
          <div class="v">${money(c._cost)}/mo</div>
        </div>
        <div class="row">
          <div class="k">${bedrooms==="1" ? "1-bedroom rent" : "2-bedroom rent"}</div>
          <div class="v">${money(c._rent)}/mo</div>
        </div>
      </div>
      <div class="details">
        ${breakdownHTML(c)}
        <div style="margin-top:10px">
          <span class="pill">Household: ${household==="single"?"Single":"Two"}</span>
          <span class="pill">Bedrooms: ${bedrooms}</span>
          <span class="pill">${sd}</span>
        </div>
      </div>
    </div>
  </article>`;
}

function render(){
  const app = $("#app");
  const openIDs = Array.from(document.querySelectorAll(".card.open")).map(c => c.dataset.id);

  const rows = computeRows();
  if(!rows.length){
    app.innerHTML = `<div class="empty">No results. Clear search or adjust inputs.</div>`;
    $("#summary").textContent = "Showing 0 cities";
    return;
  }
  app.innerHTML = `<section class="grid">${rows.map(card).join("")}</section>`;
  $("#summary").textContent = `Showing ${rows.length} ${rows.length===1?"city":"cities"}`;

  openIDs.forEach(id => {
    const el = app.querySelector(`.card[data-id="${id}"]`);
    if (el) el.classList.add("open");
  });

  hydrateImages();
}

window.addEventListener("click", (e)=>{
  const cardEl = e.target.closest(".card");
  if(cardEl){ cardEl.classList.toggle("open"); }
});
["income","search","sort"].forEach(id=>{
  const el = $("#"+id);
  el.addEventListener("input", render);
  el.addEventListener("change", render);
});
$("#btnSingle").addEventListener("click", ()=> {
  household="single";
  $("#btnSingle").setAttribute("aria-pressed","true");
  $("#btnTwo").setAttribute("aria-pressed","false");
  render();
});
$("#btnTwo").addEventListener("click", ()=> {
  household="two";
  $("#btnSingle").setAttribute("aria-pressed","false");
  $("#btnTwo").setAttribute("aria-pressed","true");
  render();
});
$("#btn1BR").addEventListener("click", ()=> {
  bedrooms="1";
  $("#btn1BR").setAttribute("aria-pressed","true");
  $("#btn2BR").setAttribute("aria-pressed","false");
  render();
});
$("#btn2BR").addEventListener("click", ()=> {
  bedrooms="2";
  $("#btn1BR").setAttribute("aria-pressed","false");
  $("#btn2BR").setAttribute("aria-pressed","true");
  render();
});

document.addEventListener("keydown", (e)=>{
  if(e.key==="Enter"){
    const cardEl = document.activeElement.closest?.(".card");
    if(cardEl){ e.preventDefault(); cardEl.classList.toggle("open"); }
  }
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement.tagName)){
    e.preventDefault(); $("#search").focus();
  }
});

// Filter toggle (all devices, text = Hide/Show filters)
const controlsEl = document.querySelector('.controls');
const filterToggleBtn = document.getElementById('filterToggle');

filterToggleBtn.addEventListener('click', () => {
  const hidden = controlsEl.classList.toggle('is-hidden');
  filterToggleBtn.setAttribute('aria-expanded', String(!hidden));
  filterToggleBtn.textContent = hidden ? 'Show filters' : 'Hide filters';
});
</script>
</body>
</html>
